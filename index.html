<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>MFI Credit Grade Calculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bg:#f7f7fb;--card:#fff;--ink:#1f2937;--muted:#6b7280;--border:#e5e7eb;--accent:#111827}
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--ink)}
    header,main{max-width:1100px;margin:0 auto;padding:16px}
    h1{margin:0 0 6px;font-size:22px}
    .muted{color:var(--muted);font-size:12px}
    .toolbar{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin:8px 0 0}
    .btn{padding:8px 12px;border:1px solid var(--border);background:#fff;border-radius:12px;cursor:pointer}
    .btn:hover{background:#f9fafb}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 1px 1px rgba(0,0,0,.02)}
    .card h2{margin:0;font-size:16px}
    .row{display:grid;grid-template-columns:1fr;gap:12px;padding:12px}
    .sub{background:#fafafa;border:1px solid var(--border);border-radius:12px;padding:12px}
    .kpi{background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px}
    .weight{font-size:12px;color:var(--muted)}
    .grid{display:grid;gap:16px}
    @media (min-width:900px){.grid{grid-template-columns:2fr 1fr}}
    .flex{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .chips{display:flex;gap:6px;margin-top:6px}
    .chip{font-size:12px;padding:2px 8px;border-radius:10px;border:1px solid var(--border);cursor:pointer}
    .chip.active{background:var(--accent);color:#fff;border-color:var(--accent)}
    .summary{padding:16px}
    .box{background:#f5f7fa;border:1px solid var(--border);border-radius:12px;padding:12px}
    input[type=number],input[type=text]{padding:8px;border:1px solid var(--border);border-radius:8px;width:80px}
    input[type=range]{width:100%}
    .small{font-size:11px}
    .h{margin:0 0 4px;font-weight:600;font-size:14px}
    .warn{background:#fff8e6;border:1px solid #facc15;color:#92400e;padding:8px 10px;border-radius:10px;font-size:12px}
    .ok{background:#ecfdf5;border:1px solid #34d399;color:#065f46;padding:6px 8px;border-radius:8px;font-size:12px}
  </style>
  <!-- SheetJS to read Excel in the browser -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
</head>
<body>
  <header>
    <h1>MFI Credit Grade Calculator</h1>
    <div class="muted">This page reads your Excel model directly, applies KPI weights, and calculates the final grade.</div>
    <div class="toolbar">
      <button id="reload" class="btn">Reload Excel</button>
      <label class="btn">Load a different Excel<input id="xlsFile" type="file" accept=".xlsx,.xls" style="display:none"></label>
      <button id="exportBtn" class="btn">Export scores</button>
      <button id="resetBtn" class="btn">Reset</button>
    </div>
    <div id="status" style="margin-top:8px"></div>
  </header>

  <main class="grid">
    <section id="left"></section>
    <aside>
      <div class="card summary">
        <div class="flex">
          <h2>Summary</h2>
        </div>
        <div class="grid" style="grid-template-columns:1fr 1fr;margin-top:12px">
          <div class="box">
            <div class="muted small">Weighted Score</div>
            <div id="scoreTotal" style="font-size:28px;font-weight:700">0.0</div>
            <div class="muted small">out of 100</div>
          </div>
          <div class="box">
            <div class="muted small">Final Grade</div>
            <div id="scoreGrade" style="font-size:28px;font-weight:700">E</div>
            <div class="muted small">bands editable</div>
          </div>
        </div>
        <div style="margin-top:16px">
          <div class="h">Grade Bands</div>
          <div class="muted small" style="margin-bottom:6px">Highest first. “min %” is the cutoff for that grade.</div>
          <div id="bands"></div>
        </div>
      </div>
      <div id="notes" style="margin-top:12px" class="muted small"></div>
    </aside>
  </main>

  <script>
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));

    // State
    let model = {};          // { Dim: { Sub: [{kpi,weight,explanation?}] } }
    let scores = {};         // { "Dim::KPI": 0..5 }
    let bands = [            // default; can be overridden from Excel if present
      { label:"A", min:85 },
      { label:"B", min:70 },
      { label:"C", min:55 },
      { label:"D", min:40 },
      { label:"E", min:0  },
    ];

    const EXCEL_PATH = "data/model.xlsx"; // place your Excel here in the repo

    // Try to parse bands from any sheet with columns like [Grade/Label, Min]
    function tryExtractBands(workbook){
      try{
        for(const name of workbook.SheetNames){
          const ws = workbook.Sheets[name];
          const aoa = XLSX.utils.sheet_to_json(ws,{header:1,defval:null});
          for(let r=0;r<Math.min(20,aoa.length);r++){
            const row = aoa[r].map(v=>String(v||"").trim().toLowerCase());
            const gi = row.findIndex(c=>["grade","label"].includes(c));
            const mi = row.findIndex(c=>["min","minimum","min %","cutoff"].includes(c));
            if(gi!==-1 && mi!==-1){
              const out=[];
              for(let k=r+1;k<aoa.length;k++){
                const lab = (aoa[k][gi]||"").toString().trim();
                const mn  = Number((aoa[k][mi]||"").toString().replace(/[^0-9.]/g,""));
                if(!lab || isNaN(mn)) continue;
                out.push({label:lab,min:mn});
              }
              if(out.length){
                out.sort((a,b)=>b.min-a.min);
                return out;
              }
            }
          }
        }
      }catch(e){console.warn("Bands parse failed:",e)}
      return null;
    }

    async function loadExcel(url){
      setStatus(`Loading Excel from ${url} ...`);
      const ab = await fetch(url,{cache:"no-store"}).then(r=>{
        if(!r.ok) throw new Error("HTTP "+r.status);
        return r.arrayBuffer();
      });
      const wb = XLSX.read(ab,{type:"array"});

      // 1) Extract Model sheet rows (by headers)
      let modelRows = null;
      let modelSheetName = null;
      for(const name of wb.SheetNames){
        const ws = wb.Sheets[name];
        const json = XLSX.utils.sheet_to_json(ws,{defval:null});
        const cols = json.length? Object.keys(json[0]).map(s=>s.trim().toLowerCase()) : [];
        if(["dimension","sub-parameter","kpi","weight"].every(k=>cols.includes(k))){
          modelRows = json; modelSheetName = name; break;
        }
      }
      if(!modelRows){
        throw new Error("Could not find a sheet with columns: Dimension, Sub-Parameter, KPI, Weight");
      }

      // 2) Build nested model and carry over explanations if found elsewhere
      const explanations = collectExplanations(wb);
      const obj = {};
      for(const row of modelRows){
        const dim = (row["Dimension"] ?? row["dimension"]).toString().trim() || null;
        const sub = (row["Sub-Parameter"] ?? row["sub-parameter"]).toString().trim() || null;
        const kpi = (row["KPI"] ?? row["kpi"]).toString().trim();
        const w   = Number(row["Weight"] ?? row["weight"]);
        if(!kpi || isNaN(w)) continue;
        const D = dim || lastNonNull(obj.__lastDim);
        const S = sub || lastNonNull(obj.__lastSub);
        obj.__lastDim = D; obj.__lastSub = S;
        obj[D] = obj[D] || {};
        obj[D][S] = obj[D][S] || [];
        obj[D][S].push({kpi, weight:w, explanation: explanations[kpi]||""});
      }
      delete obj.__lastDim; delete obj.__lastSub;

      // 3) Normalize weights (if they don't sum to 1)
      const sumW = Object.values(obj).flatMap(subs=>Object.values(subs).flatMap(arr=>arr.map(x=>x.weight))).reduce((a,b)=>a+b,0);
      let msg = `Weights sum to ${sumW.toFixed(2)}.`;
      if(Math.abs(sumW-1) > 1e-6){
        for(const subs of Object.values(obj)){
          for(const arr of Object.values(subs)) arr.forEach(x=>x.weight = x.weight / sumW);
        }
        msg += " Normalized to 1.00 for scoring.";
      }

      // 4) Try to extract grade bands
      const excelBands = tryExtractBands(wb);
      if(excelBands){ bands = excelBands; msg += ` Using grade bands from Excel: ${bands.map(b=>`${b.label}≥${b.min}`).join(", ")}.`; }
      else { msg += " Using default grade bands (A≥85, B≥70, C≥55, D≥40, else E)." }

      setStatus(msg, true);

      model = obj;
      renderBands();
      renderModel();
      recompute();
    }

    function collectExplanations(wb){
      const map = {};
      try{
        for(const name of wb.SheetNames){
          const ws = wb.Sheets[name];
          const json = XLSX.utils.sheet_to_json(ws,{defval:null});
          if(!json.length) continue;
          const cols = Object.keys(json[0]).map(s=>s.trim().toLowerCase());
          if(cols.includes("kpi") && cols.includes("explanation")){
            for(const r of json){
              const k = (r["KPI"] ?? r["kpi"])?.toString().trim();
              const e = (r["Explanation"] ?? r["explanation"])?.toString().trim();
              if(k) map[k] = e || "";
            }
          }
        }
      }catch(e){console.warn("Explanation parse failed:",e)}
      return map;
    }

    function lastNonNull(v){ return v ?? null; }

    // UI renderers
    function renderBands(){
      const host = $("#bands"); host.innerHTML = "";
      bands.forEach((b,i)=>{
        const row = document.createElement("div"); row.className = "flex"; row.style.margin = "6px 0";
        row.innerHTML = `
          <input value="${b.label}" data-idx="${i}" data-field="label" />
          <span class="muted small">min %</span>
          <input type="number" min="0" max="100" value="${b.min}" data-idx="${i}" data-field="min" />`;
        host.appendChild(row);
      });
      host.addEventListener("input", e=>{
        const idx = Number(e.target.dataset.idx); const field = e.target.dataset.field; if(idx>=0){
          if(field==="label") bands[idx].label = e.target.value || "";
          if(field==="min")   bands[idx].min   = clamp(Number(e.target.value),0,100);
          bands.sort((a,b)=>b.min-a.min); recompute();
        }
      }, { once:true });
    }

    function renderModel(){
      const left = $("#left"); left.innerHTML = "";
      for(const [dim, subs] of Object.entries(model)){
        const card = document.createElement("div"); card.className = "card";
        card.innerHTML = `<div class="flex" style="padding:12px 16px;border-bottom:1px solid var(--border)">
          <h2>${escapeHTML(dim)}</h2><div class="muted small" id="dim-${idify(dim)}"></div></div>`;
        const body = document.createElement("div"); body.className = "row";
        for(const [sub, arr] of Object.entries(subs)){
          const subDiv = document.createElement("div"); subDiv.className = "sub"; subDiv.innerHTML = `<div class="h">${escapeHTML(sub)}</div>`;
          const grid = document.createElement("div"); grid.style.display = "grid"; grid.style.gridTemplateColumns = "1fr"; grid.style.gap="12px";
          for(const item of arr){
            const key = makeKey(dim,item.kpi);
            const kpi = document.createElement("div"); kpi.className = "kpi";
            kpi.innerHTML = `<div class="flex"><div><div class="h">${escapeHTML(item.kpi)}</div>${item.explanation?`<div class=\"muted small\">${escapeHTML(item.explanation)}</div>`:""}</div><div class="weight">w: ${Number(item.weight).toFixed(2)}</div></div>
            <div style="margin-top:8px"><input type="range" min="0" max="5" step="1" value="${scores[key]??0}" data-key="${escapeHTML(key)}" />
            <div class="chips">${[0,1,2,3,4,5].map(n=>`<span class=\"chip ${scores[key]===n?"active":""}\" data-key=\"${escapeHTML(key)}\" data-val=\"${n}\">${n}</span>`).join("")}</div></div>`;
            grid.appendChild(kpi);
          }
          subDiv.appendChild(grid); body.appendChild(subDiv);
        }
        card.appendChild(body); left.appendChild(card);
      }

      left.addEventListener("input", e=>{
        if(e.target.matches('input[type="range"]')){
          const key = e.target.dataset.key; const val = clamp(Number(e.target.value),0,5);
          scores[key]=val; const parent=e.target.parentElement; parent.querySelectorAll(".chip").forEach(c=>c.classList.toggle("active", Number(c.dataset.val)===val));
          recompute();
        }
      });
      left.addEventListener("click", e=>{
        const chip=e.target.closest(".chip"); if(!chip) return; const key=chip.dataset.key; const val=clamp(Number(chip.dataset.val),0,5);
        scores[key]=val; const slider=left.querySelector(`input[type=\"range\"][data-key=\"${cssEscape(key)}\"]`); if(slider) slider.value=val; chip.parentElement.querySelectorAll(".chip").forEach(c=>c.classList.toggle("active", c===chip));
        recompute();
      });
    }

    function recompute(){
      let total=0; const perDim={}; const perDimDen={};
      for(const [dim, subs] of Object.entries(model)){
        let dSum=0, dW=0; for(const arr of Object.values(subs)) for(const item of arr){
          const key = makeKey(dim,item.kpi); const s = clamp(Number(scores[key]??0),0,5); const w = Number(item.weight||0);
          dSum += w * (s/5); dW += w; total += w * (s/5);
        }
        perDim[dim]=dSum; perDimDen[dim]=dW||1;
      }
      const totalPct = clamp(Number((total*100).toFixed(2)),0,100);
      $("#scoreTotal").textContent = totalPct.toFixed(1);
      const sorted=[...bands].sort((a,b)=>b.min-a.min); let grade = sorted[sorted.length-1]?.label||"N/A"; for(const b of sorted) if(totalPct>=b.min){grade=b.label;break}
      $("#scoreGrade").textContent = grade;
      for(const [dim,val] of Object.entries(perDim)){
        const el = document.getElementById("dim-"+idify(dim)); if(el) el.textContent = `Dim. score: ${((val/(perDimDen[dim]||1))*100).toFixed(1)}%`;
      }
    }

    function onExport(){
      const out = { scores, gradedAt:new Date().toISOString() };
      const blob = new Blob([JSON.stringify(out,null,2)],{type:"application/json"});
      const url = URL.createObjectURL(blob); const a = document.createElement("a"); a.href=url; a.download="mfi_scores.json"; a.click(); URL.revokeObjectURL(url);
    }

    function setStatus(msg, ok){
      const el=$("#status"); if(!el) return; el.innerHTML = ok? `<span class=ok>${escapeHTML(msg)}</span>` : `<span class=warn>${escapeHTML(msg)}</span>`;
    }

    function makeKey(dim,kpi){return `${dim}::${kpi}`}
    function idify(s){return String(s).toLowerCase().replace(/[^a-z0-9]+/g,"-")}
    function escapeHTML(s){return String(s??"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]))}
    function cssEscape(str){return String(str).replace(/(["\\\n\r\t\f])/g,"\\$1").replace(/[:]/g,"\\:")}

    // Wire toolbar
    $("#exportBtn").addEventListener("click", onExport);
    $("#resetBtn").addEventListener("click", ()=>{scores={}; $$('input[type="range"]').forEach(x=>x.value=0); recompute();});
    $("#reload").addEventListener("click", ()=> loadExcel(EXCEL_PATH));
    $("#xlsFile").addEventListener("change", async e=>{
      const file=e.target.files?.[0]; if(!file) return; const ab=await file.arrayBuffer(); const wb=XLSX.read(ab,{type:"array"});
      const bandsFromX = tryExtractBands(wb); if(bandsFromX){bands = bandsFromX; renderBands();}
      const tmpURL = URL.createObjectURL(new Blob([ab])); await loadExcel(tmpURL); URL.revokeObjectURL(tmpURL);
    });

    // Boot
    loadExcel(EXCEL_PATH).catch(err=> setStatus("Failed to load Excel: "+err.message));
  </script>
</body>
</html>
